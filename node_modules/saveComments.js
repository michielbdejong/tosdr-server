'use strict';

module.exports = function(req, res, next){
	if('POST' !== req.method){
		console.log('Should be post');
		return next();
	}
	
	var comment = req.body.comment;
	if(undefined === comment || comment.length <= 0){
		console.log('No comment defined');
	 	res.send(500);
	}
	var q = module.require('q'),
	    fs = module.require('fs'),
	    path = module.require('path'),
	    moment = module.require('moment'),
	    config = module.require('config');
	var timestamp = moment().unix(),
	    email = req.session.email,
	    target = path.resolve(path.dirname(module.parent.filename), '../', config.comments.target),
	    defer = q.defer();
	
	fs.exists(target, defer.resolve);
	var p = defer.promise
	
	p.then(function(exists){
	 	if(exists){
	 		return;
	 	}
	 	var mkdirDefer = q.defer();
	 	fs.mkdir(target, mkdirDefer.resolve);
	 	return mkdirDefer.promise;
	 })
	 .then(function(){
	 	return q.nfcall(fs.writeFile,
	 	                path.resolve(target, timestamp + email),
	 	                JSON.stringify({comment: comment, timestamp: timestamp, email: email}))
	 })
	 .then(function(){
	 	res.send(200);
	 })
	 .fail(function(error){
	 	console.error(error);
	 	res.send(500);
	 });
};
