'use strict';

module.exports = function(req, res, next){
	var q = module.require('q'),
	    fs = module.require('fs'),
	    path = module.require('path'),
	    config = module.require('config');

	if(!config['tosdr-files'] || !config['tosdr-files'].location){
		console.log('Location of tosdr.org files should be defined');
		return next();
	}

	var defer = q.defer(),
	servicesDir = path.resolve(path.dirname(module.parent.filename), '../', config['tosdr-files'].location, './services');

	q.nfcall(fs.readdir, servicesDir)
	.then(function(files){
	// Read all files in services/*.json,
	// saving the value of the 'id' field to the services array
		return files.reduce(function(soFar, file){
			if(file.substr(-5) !== '.json'){
				return soFar;
			}
			return soFar.then(function(services){
				return q.nfcall(fs.readFile, path.resolve(servicesDir, file))
				.then(function(contents){
					services = services || [];
					services.push(JSON.parse(contents).id);
					return services;
				});
			});
		}, q([]));
	})
	.then(function(services){
		res.send(200, services);
	})
	.fail(function(error){
		console.error(error);
		res.send(500);
	});
};
